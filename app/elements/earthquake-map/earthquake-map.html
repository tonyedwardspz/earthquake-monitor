<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/google-map/google-map.html">
<link rel="import" href="../../../bower_components/iron-localstorage/iron-localstorage.html">


<dom-module id="earthquake-map">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-localstorage name="earthquake-data"
                   on-iron-localstorage-load="_backupLoaded"
                   value="{{backupEarthQuakes}}">
  </iron-localstorage>

    <iron-ajax auto
      url="http://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/1.0_week.csv"
      handle-as="text/plain"
      last-response="{{data}}"></iron-ajax>

    <google-map id="main-map" latitude="22" longitude="0" zoom="2" min-zoom="2">
      <template is='dom-repeat' items="[[getEarthquakes]]">
        <google-map-marker latitude="[[item.latitude]]" longitude="[[item.longitude]]">
          <img src="http://placekitten.com/200/300" alt="place kitten!">
          <span>[[item.place]]</span>
        </google-map-marker>
      </template>
    </google-map>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'earthquake-map',

      properties: {
        data: {},
        getEarthquakes: {
          computed: 'processData(data)'
        },
        earthQuakes: {
          type: Array
        },
        loaded: {
          boolean: false
        }
      },
      // Process data from ajax-call. Return to main app for processing and
      // then return for internal use.
      processData: function(data){
        // if (earthQuakes.length > 1 && loaded){
        //   return earthQuakes
        // }
        // this.loaded = true;

        var json = Helper.CSV2JSON(data);
        this.earthQuakes = JSON.parse(json);
        populateUI(json);
        earthQuakes.pop();
        this.backupEarthQuakes = this.earthQuakes;
        return earthQuakes
      },
      _backupLoaded: function() {
        this.earthQuakes = this.backupEarthQuakes.slice();
      }
    });
  })();
  </script>
</dom-module>
